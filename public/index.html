<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Status Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github-dark.css"
      rel="stylesheet"
    />
    <style>
      #dashboard {
        display: none;
      }
      .service-card {
        margin-bottom: 1rem;
      }
      .service-card .card-header {
        font-weight: bold;
      }
      #log-display-container {
        display: none;
        margin-top: 2rem;
      }
      pre {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f8f9fa;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Service Status Dashboard</h1>

      <!-- Login Form -->
      <div id="login-form">
        <h2>Login</h2>
        <form id="login">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="password"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>

      <!-- Dashboard -->
      <div id="dashboard">
        <h2>Services</h2>
        <div id="service-cards" class="row">
          <!-- Service cards will be dynamically loaded here -->
        </div>
        <!-- Log Display Container -->
        <div id="log-display-container" class="card">
          <div class="card-header">
            <h3>Logs for <span id="log-service-name"></span></h3>
          </div>
          <div class="card-body">
            <pre><code id="log-content" class="plaintext"></code></pre>
            <button id="download-log" class="btn btn-secondary mt-3">
              Download Log
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const loginForm = document.getElementById("login");
      const dashboard = document.getElementById("dashboard");
      const loginDiv = document.getElementById("login-form");
      const serviceCardsContainer = document.getElementById("service-cards");
      const logDisplayContainer = document.getElementById(
        "log-display-container"
      );
      const logServiceName = document.getElementById("log-service-name");
      const logContent = document.getElementById("log-content");
      const downloadLogButton = document.getElementById("download-log");
      let currentLogFile = "";
      const serviceLoadingStates = {};

      document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const response = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        if (response.ok) {
          loginDiv.style.display = "none";
          dashboard.style.display = "block";
          fetchServices();
        } else {
          alert("Login failed. Please check your credentials.");
        }
      });

      async function fetchServices() {
        const response = await fetch("/services");
        if (!response.ok) {
          alert("Failed to fetch services.");
          return;
        }

        const services = await response.json();
        serviceCardsContainer.innerHTML = "";
        services.forEach((service) => {
          const statusClass =
            service.status === "active" ? "text-success" : "text-danger";
          const card = document.createElement("div");
          card.className = "col-md-4 service-card";
          card.setAttribute("data-service-id", service.id);
          card.innerHTML = `
      <div class="card">
          <div class="card-header">
              ${service.name}
          </div>
          <div class="card-body">
              <p class="card-text">
                  Status: <strong class="${statusClass}">${
            service.status
          }</strong>
              </p>
              <div>
                  ${service.logs
                    .map(
                      (log) => `
                      <button class="btn btn-info btn-sm" onclick="viewSpecificLog(${
                        service.id
                      }, '${log}', '${log.split("/").pop()}')">
                          View ${log.split("/").pop()}
                      </button>`
                    )
                    .join(" ")}
              </div>
              <button class="btn btn-primary btn-sm mt-2" onclick="restartService(${
                service.id
              })">Restart</button>
          </div>
      </div>
    `;
          serviceCardsContainer.appendChild(card);
        });

        // Initialize the loading state for each service
        services.forEach((service) => {
          if (!(service.id in serviceLoadingStates)) {
            serviceLoadingStates[service.id] = false;
          }
        });

        updateLoadingStates();
      }
      async function restartService(id) {
        // Set the loading state for the specific service
        serviceLoadingStates[id] = true;
        updateLoadingStates();

        const response = await fetch(`/services/${id}/restart`, {
          method: "POST",
        });

        // Reset the loading state after the promise resolves
        serviceLoadingStates[id] = false;
        updateLoadingStates();

        if (response.ok) {
          alert("Service restarted successfully.");
          fetchServices();
        } else {
          alert("Failed to restart service.");
        }
      }

      function updateLoadingStates() {
        // Update the UI based on the loading state
        document.querySelectorAll(".service-card").forEach((card) => {
          const serviceId = card.getAttribute("data-service-id");
          const isLoading = serviceLoadingStates[serviceId];
          const restartButton = card.querySelector(".btn-primary");

          if (isLoading) {
            card.classList.add("loading");
            restartButton.disabled = true;
            restartButton.innerHTML =
              '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restarting...';
          } else {
            card.classList.remove("loading");
            restartButton.disabled = false;
            restartButton.textContent = "Restart";
          }
        });
      }

      async function viewSpecificLog(serviceId, logFile, logName) {
        const response = await fetch(
          `/services/${serviceId}/logs?file=${encodeURIComponent(logFile)}`
        );
        if (!response.ok) {
          alert(`Failed to fetch ${logName} for service.`);
          return;
        }

        const logs = await response.json(); // Expecting an array of logs
        const log = logs.find((l) => l.file === logFile); // Match the correct log by file

        if (!log || !log.content) {
          alert(`No content found for ${logName}.`);
          return;
        }

        currentLogFile = logFile; // Store the current log file for downloading
        logServiceName.textContent = logName; // Update the displayed log name
        logContent.textContent = log.content; // Display the log content in the designated container

        // Apply syntax highlighting to the log content
        hljs.highlightElement(logContent);

        // Show the log display container
        logDisplayContainer.style.display = "block";

        // Update the download button functionality
        downloadLogButton.onclick = () => {
          const url = `/services/${serviceId}/logs/download?file=${encodeURIComponent(
            logFile
          )}`;
          const a = document.createElement("a");
          a.href = url;
          a.download = logName; // Set the file name for download
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
      }
    </script>
  </body>
</html>
