<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Status Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github-dark.css"
      rel="stylesheet"
    />
    <style>
      #dashboard {
        display: none;
      }
      .service-card {
        margin-bottom: 1rem;
      }
      .service-card .card-header {
        font-weight: bold;
      }
      #log-display-container {
        display: none;
        margin-top: 2rem;
      }
      pre {
        max-height: 400px;
        overflow-y: auto;
      }
      #log-tabs {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Service Status Dashboard</h1>

      <!-- Login Form -->
      <div id="login-form">
        <h2>Login</h2>
        <form id="login">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="password"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
        </form>
      </div>

      <!-- Dashboard -->
      <div id="dashboard">
        <h2>Services</h2>
        <div id="service-cards" class="row">
          <!-- Service cards will be dynamically loaded here -->
        </div>
        <!-- Log Display Container -->
        <div id="log-display-container" class="card">
          <div class="card-header">
            <h3>Logs for <span id="log-service-name"></span></h3>
          </div>
          <div class="card-body">
            <ul id="log-tabs" class="nav nav-tabs"></ul>
            <pre><code id="log-content" class="plaintext"></code></pre>
            <button id="download-log" class="btn btn-secondary mt-3">
              Download Log
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const loginForm = document.getElementById("login");
      const dashboard = document.getElementById("dashboard");
      const loginDiv = document.getElementById("login-form");
      const serviceCardsContainer = document.getElementById("service-cards");
      const logDisplayContainer = document.getElementById(
        "log-display-container"
      );
      const logServiceName = document.getElementById("log-service-name");
      const logTabs = document.getElementById("log-tabs");
      const logContent = document.getElementById("log-content");
      const downloadLogButton = document.getElementById("download-log");
      let currentLogFile = "";

      document.addEventListener("DOMContentLoaded", () => {
        hljs.highlightAll();
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const response = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        if (response.ok) {
          loginDiv.style.display = "none";
          dashboard.style.display = "block";
          fetchServices();
        } else {
          alert("Login failed. Please check your credentials.");
        }
      });

      async function fetchServices() {
        const response = await fetch("/services");
        if (!response.ok) {
          alert("Failed to fetch services.");
          return;
        }

        const services = await response.json();
        serviceCardsContainer.innerHTML = "";
        services.forEach((service) => {
          const statusClass =
            service.status === "active" ? "text-success" : "text-danger";
          const card = document.createElement("div");
          card.className = "col-md-4 service-card";
          card.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            ${service.name}
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                Status: <strong class="${statusClass}">${service.status}</strong>
                            </p>
                            <button class="btn btn-primary btn-sm" onclick="restartService(${service.id})">Restart</button>
                            <button class="btn btn-secondary btn-sm" onclick="viewLogs(${service.id}, '${service.name}')">View Logs</button>
                        </div>
                    </div>
                `;
          serviceCardsContainer.appendChild(card);
        });
      }

      async function restartService(id) {
        const response = await fetch(`/services/${id}/restart`, {
          method: "POST",
        });
        if (response.ok) {
          alert("Service restarted successfully.");
          fetchServices();
        } else {
          alert("Failed to restart service.");
        }
      }

      async function viewLogs(serviceId, serviceName) {
        const response = await fetch(`/services/${serviceId}/logs`);
        if (!response.ok) {
          alert(`Failed to fetch logs for ${serviceName}.`);
          return;
        }

        const logs = await response.json();
        logTabs.innerHTML = "";

        // Create tabs for logs
        logs.forEach((log, index) => {
          const logTab = document.createElement("li");
          logTab.className = "nav-item";
          logTab.innerHTML = `
      <button class="nav-link ${index === 0 ? "active" : ""}" data-log-file="${
            log.file
          }" onclick="showLogContent('${log.file}', '${
            log.content
          }', ${serviceId}, '${serviceName}', this)">
        ${log.file.split("/").pop()}
      </button>
    `;
          logTabs.appendChild(logTab);
        });

        // Show the first log by default
        if (logs.length > 0) {
          showLogContent(
            logs[0].file,
            logs[0].content,
            serviceId,
            serviceName,
            logTabs.querySelector(".nav-link")
          );
        }

        logServiceName.textContent = serviceName;
        logDisplayContainer.style.display = "block";
      }

      function showLogContent(file, content, serviceId, serviceName, tab) {
        currentLogFile = file;
        logContent.textContent = content;
        hljs.highlightElement(logContent);

        // Update active tab
        const tabs = logTabs.querySelectorAll(".nav-link");
        tabs.forEach((t) => t.classList.remove("active"));
        if (tab) tab.classList.add("active");

        // Update download button
        downloadLogButton.onclick = () => {
          const url = `/services/${serviceId}/logs/download?file=${encodeURIComponent(
            file
          )}`;
          const a = document.createElement("a");
          a.href = url;
          a.download = `${serviceName}-${file.split("/").pop()}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };
      }
    </script>
  </body>
</html>
